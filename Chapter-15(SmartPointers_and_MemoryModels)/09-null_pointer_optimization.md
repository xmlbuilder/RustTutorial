

# null pointer optimization

Rustμ λ„ ν¬μΈν„° μµμ ν™”(null pointer optimization) κ°λ…μ„ μ‹¤ν—μ μΌλ΅ λ³΄μ—¬μ£Όλ” μμ μ…λ‹λ‹¤.
μ•„λμ— κ°λ… μ„¤λ…, μ½”λ“ λ¶„μ„, κ·Έλ¦¬κ³  μ™ μ΄κ² μ¤‘μ”ν•μ§€κΉμ§€ κΉμ΄ μκ² μ •λ¦¬.

## π§  λ„ ν¬μΈν„° μµμ ν™”λ€?
Rustμ—μ„λ” Option<T> νƒ€μ…μ΄ μμ„ λ•,
μΌλ°μ μΌλ΅ Tμ ν¬κΈ°λ³΄λ‹¤ λ” ν° λ©”λ¨λ¦¬λ¥Ό μ°¨μ§€ν•  κ²ƒ κ°™μ§€λ§,
νΉμ • νƒ€μ…μ— λ€ν•΄μ„λ” Option<T>κ°€ Tμ™€ κ°™μ€ ν¬κΈ°λ¥Ό κ°–λ„λ΅ μµμ ν™”ν•©λ‹λ‹¤.

### μμ‹:
```rust
size_of::<&i32>() == size_of::<Option<&i32>>() // true
```

- Rustλ” μ°Έμ΅° νƒ€μ…(&T)μ—μ„ **λ„ ν¬μΈν„°(null pointer)**λ¥Ό NoneμΌλ΅ μ‚¬μ©ν•κ³ 
- λ„μ΄ μ•„λ‹ ν¬μΈν„°λ¥Ό Some(&T)λ΅ μ‚¬μ©ν•¨
- λ”°λΌμ„ μ¶”κ°€ λ©”λ¨λ¦¬ μ—†μ΄ Option<&T>λ¥Ό ν‘ν„ν•  μ μμ

## π” μ½”λ“ λ¶„μ„
```rust
use std::mem::transmute;
macro_rules! dbg_bits {
    ($e:expr, $bit_type:ty) => {
        println!("- {}: {:#x}", stringify!($e), transmute::<_, $bit_type>($e));
    };
}
```
- transmuteλ” νƒ€μ…μ„ κ°•μ λ΅ λ³€ν™ν•λ” unsafe ν•¨μ
- dbg_bits! λ§¤ν¬λ΅λ” ν‘ν„μ‹μ λΉ„νΈ ν¨ν„΄μ„ μ¶λ ¥ν•¨
- stringify!($e)λ” ν‘ν„μ‹μ„ λ¬Έμμ—΄λ΅ μ¶λ ¥

## π”§ main() ν•¨μ ν•΄μ„
```rust
unsafe {
    println!("bool:");
    dbg_bits!(false, u8); // 0x0
    dbg_bits!(true, u8);  // 0x1
}
```


- boolμ€ 1λ°”μ΄νΈλ΅ ν‘ν„λ¨
- false β†’ 0x0, true β†’ 0x1

## π”§ Option<bool> μ¶λ ¥
```rust
dbg_bits!(None::<bool>, u8);       // 0x2
dbg_bits!(Some(false), u8);        // 0x0
dbg_bits!(Some(true), u8);         // 0x1
```

- Rustλ” Option<bool>μ„ 1λ°”μ΄νΈλ΅ ν‘ν„ν•¨
- Noneμ€ **λ¶κ°€λ¥ν• κ°’(0x2)**λ΅ ν‘ν„ β†’ boolμ€ 0κ³Ό 1λ§ μ‚¬μ©ν•λ―€λ΅ κ°€λ¥
- μ΄κ² λ°”λ΅ enum μµμ ν™”μ ν•µμ‹¬

## π”§ Option<Option<bool>>
```rust
dbg_bits!(Some(Some(false)), u8);  // 0x0
dbg_bits!(Some(Some(true)), u8);   // 0x1
dbg_bits!(Some(None::<bool>), u8); // 0x2
dbg_bits!(None::<Option<bool>>, u8); // 0x3
```

- 2λ‹¨κ³„ Optionμ΄μ§€λ§ μ—¬μ „ν 1λ°”μ΄νΈλ΅ ν‘ν„
- Rustλ” κ°€λ¥ν• κ°’μ μ΅°ν•©μ„ λ¶„μ„ν•΄μ„ μµμ ν™”λ ν‘ν„μ„ λ§λ“¤μ–΄λƒ„

## π”§ Option<&i32>
```rust
dbg_bits!(None::<&i32>, usize);     // 0x0
dbg_bits!(Some(&0i32), usize);      // 0xμ£Όμ†κ°’
```

- Noneμ€ **λ„ ν¬μΈν„°(0x0)**λ΅ ν‘ν„
- Some(&0i32)λ” μ‹¤μ  λ©”λ¨λ¦¬ μ£Όμ†κ°’μΌλ΅ ν‘ν„
- μ΄κ² λ°”λ΅ λ„ ν¬μΈν„° μµμ ν™”μ λ€ν‘ μ‚¬λ΅€

### β οΈ μ£Όμμ‚¬ν•­
μ΄ μ½”λ“λ” λΉ„νΈ ν¨ν„΄μ„ ν™•μΈν•λ” μ‹¤ν—μ©μ΄λ©°,
transmuteλ” μ»΄νμΌλ¬κ°€ λ³΄μ¥ν•μ§€ μ•λ” λ‚΄λ¶€ ν‘ν„μ„ κ°•μ λ΅ ν•΄μ„ν•λ” λ°©μ‹μ…λ‹λ‹¤.

- Rustλ” λΉ„νΈ ν¨ν„΄μ„ λ³΄μ¥ν•μ§€ μ•μ
- μ΄ μ½”λ“λ¥Ό μ‹¤λ¬΄μ—μ„ μ‚¬μ©ν•λ©΄ undefined behavior λ°μƒ κ°€λ¥
- μ¤μ§ ν•™μµμ©, λ””λ²„κΉ…μ©μΌλ΅λ§ μ‚¬μ©ν•΄μ•Ό ν•¨


## β… μ”μ•½: λ„ ν¬μΈν„° μµμ ν™”
| ν•­λ©                  | μ„¤λ…                                                                 |
|-----------------------|----------------------------------------------------------------------|
| μµμ ν™” λ€μƒ            | Option<&T> νƒ€μ…                                                     |
| ν¬κΈ° λΉ„κµ              | size_of::<Option<&T>>() == size_of::<&T>()                          |
| μµμ ν™” λ°©μ‹            | Noneμ€ null ν¬μΈν„°(0x0), Someμ€ μ ν¨ν• μ£Όμ†κ°’μΌλ΅ ν‘ν„              |
| λ©”λ¨λ¦¬ μ μ•½ ν¨κ³Ό        | μ¶”κ°€ λ©”λ¨λ¦¬ μ—†μ΄ Option ν‘ν„ κ°€λ¥ β†’ μ‹μ¤ν… ν”„λ΅κ·Έλλ°μ— μ λ¦¬          |
| μ£Όμμ‚¬ν•­               | λΉ„νΈ ν¨ν„΄μ€ μ»΄νμΌλ¬κ°€ λ³΄μ¥ν•μ§€ μ•μ β†’ transmute μ‚¬μ©μ€ unsafe       |

## π’΅ κ²°λ΅ 
Rustλ” μ•μ „μ„±κ³Ό μ„±λ¥μ„ λ™μ‹μ— μ¶”κµ¬ν•λ” μ–Έμ–΄μ΄λ©°,
μ΄λ° μµμ ν™”λ” κ·Έ μ² ν•™μ„ λ³΄μ—¬μ£Όλ” λ€ν‘μ μΈ μ‚¬λ΅€μ…λ‹λ‹¤.
ν•μ§€λ§ λΉ„νΈ ν¨ν„΄μ— μμ΅΄ν•λ” μ½”λ“λ” μ„ν—ν•λ―€λ΅,
λ°λ“μ‹ κ³µμ‹ APIμ™€ μ•μ „ν• μ¶”μƒν™”λ¥Ό ν†µν•΄ μ‚¬μ©ν•λ” κ²ƒμ΄ λ°”λμ§ν•©λ‹λ‹¤.


