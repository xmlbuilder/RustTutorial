# Spare Matrix

## ğŸ§  CSR(Compressed Sparse Row) í•µì‹¬ ìš”ì•½
CSRì€ **í¬ì†Œ í–‰ë ¬(sparse matrix)** ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•œ ë°©ì‹ìœ¼ë¡œ, 0ì´ ì•„ë‹Œ ê°’ë§Œ ì €ì¥í•©ë‹ˆë‹¤.  
ì„¸ ê°œì˜ ë²¡í„° i, j, aë¥¼ í†µí•´ ì „ì²´ í–‰ë ¬ì„ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

### ğŸ“¦ êµ¬ì„± ìš”ì†Œ

| ì´ë¦„ | ì˜ë¯¸             | ê¸¸ì´         |
|------|------------------|--------------|
| a    | ë¹„ì œë¡œ ê°’ë“¤       | nnz          |
| j    | ê° ê°’ì˜ ì—´ ì¸ë±ìŠ¤ | nnz          |
| i    | ê° í–‰ì˜ ì‹œì‘ ìœ„ì¹˜ | n_rows + 1   |


### ğŸ§© ì˜ˆì œ í–‰ë ¬
#### í–‰ë ¬ A (3Ã—4):
```
A = [
  [10, 0, 0, 2],
  [ 3, 9, 0, 0],
  [ 0, 7, 8, 7]
]
```
### 1ï¸âƒ£ aì™€ j êµ¬ì„± (aì™€ jëŠ” â€œë¹„ì œë¡œë“¤â€ë§Œ ì°¨ë¡€ëŒ€ë¡œ ì €ì¥)

| í–‰  | j (ì—´ ì¸ë±ìŠ¤) | a (ê°’) |
|-----|---------------|--------|
| 0í–‰ | [0, 3]        | [10, 2]|
| 1í–‰ | [0, 1]        | [3, 9] |
| 2í–‰ | [1, 2, 3]     | [7, 8, 7] |

- â†’ j = [0, 3, 0, 1, 1, 2, 3]
- â†’ a = [10, 2, 3, 9, 7, 8, 7]

### 2ï¸âƒ£ i êµ¬ì„±

| í–‰ ë²ˆí˜¸ | ì‹œì‘ ì¸ë±ìŠ¤ | ì„¤ëª…                         |
|---------|--------------|------------------------------|
| 0í–‰     | 0            | 0ë²ˆì§¸ë¶€í„° ì‹œì‘               |
| 1í–‰     | 2            | ì• í–‰ì˜ 2ê°œ ë‹¤ìŒë¶€í„° ì‹œì‘    |
| 2í–‰     | 4            | ì• í–‰ì˜ 2ê°œ ë‹¤ìŒë¶€í„° ì‹œì‘    |
| ë      | 7            | ì „ì²´ ë¹„ì œë¡œ ê°œìˆ˜             |

- â¡ï¸ i = [0, 2, 4, 7]

- 0í–‰: ì²« ì›ì†ŒëŠ” 0ë²ˆì§¸ë¶€í„° ì‹œì‘ (i[0] = 0)
- 1í–‰: ê·¸ ë‹¤ìŒ 2ê°œ (i[1] = 2)
- 2í–‰: ê·¸ ë‹¤ìŒ 2ê°œ (i[2] = 4)
- ë§ˆì§€ë§‰: ì „ì²´ ë¹„ì œë¡œ ê°œìˆ˜ 7 (i[3] = 7)

### ğŸ” ì´ ì„¸ ê°œë¡œ ì–´ë–»ê²Œ í–‰ë ¬ì´ ë§Œë“¤ì–´ì§€ëŠ”ê°€?
```
i = [0, 2, 4, 7]
j = [0, 3, 0, 1, 1, 2, 3]
a = [10, 2, 3, 9, 7, 8, 7]
```

- í–‰ 0: i[0]..i[1] = 0..2  
    â†’ j[0..2] = [0,3], a[0..2] = [10,2]  
    â†’ (0,0)=10, (0,3)=2  

- í–‰ 1: i[1]..i[2] = 2..4  
    â†’ j[2..4] = [0,1], a[2..4] = [3,9]  
    â†’ (1,0)=3, (1,1)=9  

- í–‰ 2: i[2]..i[3] = 4..7  
    â†’ j[4..7] = [1,2,3], a[4..7] = [7,8,7]  
    â†’ (2,1)=7, (2,2)=8, (2,3)=7  

- ì´ ì •ë³´ë¡œ ì›ë˜ì˜ A ì „ì²´ í–‰ë ¬ì„ 100% ë³µì›í•  ìˆ˜ ìˆìŒ.

## ğŸ” ë³µì› ë°©ì‹
### ê° í–‰ rì— ëŒ€í•´:
```rust
for k in i[r]..i[r+1] {
    A[r, j[k]] = a[k];
}
```
### ì‹œê°í™”
```
í–‰ ì¸ë±ìŠ¤:  0 | 1 | 2 | 3
i:         [0, 2, 4, 7]
                 |  |  |
                 â†“  â†“  â†“
j,a êµ¬ê°„:   [0..2) [2..4) [4..7)
```

### ğŸ”¬ Rust ì½”ë“œ ì˜ˆì œ
```rust
fn print_from_csr(i: &[usize], j: &[usize], a: &[f64], n_rows: usize, n_cols: usize) {
    println!("CSR to Dense Matrix:");
    for r in 0..n_rows {
        let mut row = vec![0.0; n_cols];
        let start = i[r];
        let end = i[r + 1];
        for k in start..end {
            row[j[k]] = a[k];
        }
        println!("{:?}", row);
    }
}

fn main() {
    let i = vec![0, 2, 4, 7];
    let j = vec![0, 3, 0, 1, 1, 2, 3];
    let a = vec![10.0, 2.0, 3.0, 9.0, 7.0, 8.0, 7.0];

    print_from_csr(&i, &j, &a, 3, 4);
}
```

### ì¶œë ¥ ê²°ê³¼
```
CSR to Dense Matrix:
[10.0, 0.0, 0.0, 2.0]
[3.0, 9.0, 0.0, 0.0]
[0.0, 7.0, 8.0, 7.0]
```

### ì‹œê°í™”
```mermaid
graph TD
    %% i ë²¡í„°: í–‰ ì‹œì‘ ì¸ë±ìŠ¤
    I0["i[0] = 0"]
    I1["i[1] = 2"]
    I2["i[2] = 4"]
    I3["i[3] = 7"]

    %% j ë²¡í„°: ì—´ ì¸ë±ìŠ¤
    J0["j[0] = 0"]
    J1["j[1] = 3"]
    J2["j[2] = 0"]
    J3["j[3] = 1"]
    J4["j[4] = 1"]
    J5["j[5] = 2"]
    J6["j[6] = 3"]

    %% a ë²¡í„°: ê°’
    A0["a[0] = 10"]
    A1["a[1] = 2"]
    A2["a[2] = 3"]
    A3["a[3] = 9"]
    A4["a[4] = 7"]
    A5["a[5] = 8"]
    A6["a[6] = 7"]

    %% ì—°ê²°: i â†’ j â†’ a
    I0 --> J0 --> A0
    I0 --> J1 --> A1
    I1 --> J2 --> A2
    I1 --> J3 --> A3
    I2 --> J4 --> A4
    I2 --> J5 --> A5
    I2 --> J6 --> A6
```

## âœ… ìµœì¢… ì •ë¦¬

| ì´ë¦„ | ì—­í•  |
|------|------|
| i    | i[r]..i[r+1] â†’ rí–‰ì˜ ë²”ìœ„ |
| j    | ê° ë¹„ì œë¡œ í•­ëª©ì˜ ì—´ ì¸ë±ìŠ¤ |
| a    | ê° ë¹„ì œë¡œ í•­ëª©ì˜ ì‹¤ì œ ê°’ |
|      | for k in i[r]..i[r+1] { A[r, j[k]] = a[k] } |

---

## ğŸ§  CSC(Compressed Sparse Column) í•µì‹¬ ìš”ì•½ 
CSRê³¼ ë°˜ëŒ€ë˜ëŠ” ë°©ì‹ì¸ CSC(Compressed Sparse Column) ë°©ì‹ìœ¼ë¡œ ì„¤ëª…  
CSCëŠ” ì—´ ì¤‘ì‹¬ìœ¼ë¡œ í¬ì†Œ í–‰ë ¬ì„ ì €ì¥í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.  
0ì´ ì•„ë‹Œ ê°’ë§Œ ì €ì¥í•˜ë©°, ì„¸ ê°œì˜ ë²¡í„° a, i, jë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### ğŸ“¦ êµ¬ì„± ìš”ì†Œ
| ì´ë¦„ | ì˜ë¯¸                         | ê¸¸ì´         |
|------|------------------------------|--------------|
| a    | ë¹„ì œë¡œ ê°’ë“¤                  | nnz          |
| i    | ê° ê°’ì˜ í–‰ ì¸ë±ìŠ¤            | nnz          |
| j    | ê° ì—´ì˜ ì‹œì‘ ìœ„ì¹˜ (ëˆ„ì í•©)   | n_cols + 1   |



### ğŸ§© ì˜ˆì œ í–‰ë ¬
#### í–‰ë ¬ A (3Ã—4):
```
A = [
  [10, 0, 0, 2],
  [ 3, 9, 0, 0],
  [ 0, 7, 8, 7]
]
```

### 1ï¸âƒ£ aì™€ i êµ¬ì„± (ì—´ ê¸°ì¤€)

| ì—´  | i (í–‰ ì¸ë±ìŠ¤) | a (ê°’) |
|-----|----------------|--------|
| 0ì—´ | [0, 1]         | [10, 3]|
| 1ì—´ | [1, 2]         | [9, 7] |
| 2ì—´ | [2]            | [8]    |
| 3ì—´ | [0, 2]         | [2, 7] |


- â†’ i = [0, 1, 1, 2, 0, 2]
- â†’ a = [10, 3, 9, 7, 8, 2, 7]
- â†’ j = [0, 2, 4, 5, 7] â† ì—´ë³„ ì‹œì‘ ì¸ë±ìŠ¤

### ğŸ”¬ Rust êµ¬í˜„ ì˜ˆì œ
```rust
fn print_from_csc(j: &[usize], i: &[usize], a: &[f64], n_rows: usize, n_cols: usize) {
    println!("CSC to Dense Matrix:");
    let mut matrix = vec![vec![0.0; n_cols]; n_rows];

    for col in 0..n_cols {
        let start = j[col];
        let end = j[col + 1];
        for k in start..end {
            let row = i[k];
            matrix[row][col] = a[k];
        }
    }

    for row in matrix {
        println!("{:?}", row);
    }
}

fn main() {
    let j = vec![0, 2, 4, 5, 7]; // ì—´ ì‹œì‘ ìœ„ì¹˜
    let i = vec![0, 1, 1, 2, 2, 0, 2]; // í–‰ ì¸ë±ìŠ¤
    let a = vec![10.0, 3.0, 9.0, 7.0, 8.0, 2.0, 7.0]; // ê°’

    print_from_csc(&j, &i, &a, 3, 4);
}
```

### ì¶œë ¥ ê²°ê³¼
```
CSC to Dense Matrix:
[10.0, 0.0, 0.0, 2.0]
[3.0, 9.0, 0.0, 0.0]
[0.0, 7.0, 8.0, 7.0]
```


## âœ… ìµœì¢… ì •ë¦¬
| ì´ë¦„ | ì—­í•  |
|------|------|
| j    | j[c]..j[c+1] â†’ cì—´ì˜ ë²”ìœ„ |
| i    | ê° ë¹„ì œë¡œ í•­ëª©ì˜ í–‰ ì¸ë±ìŠ¤ |
| a    | ê° ë¹„ì œë¡œ í•­ëª©ì˜ ì‹¤ì œ ê°’ |
|      | for k in j[c]..j[c+1] { A[i[k], c] = a[k] } |

---

## í…ŒìŠ¤íŠ¸ ì½”ë“œ
```rust

#[cfg(test)]
mod tests_csr {
    use geometry::geom::utils::math::{
        on_csr_from_dense, 
        on_csr_from_triplets, 
        on_csr_row_dot, 
        on_print_dense_from_csr, 
        on_print_from_csc};

    #[test]
    fn test_csr_row_dot() {
        let i = vec![0usize, 2, 4, 7];
        let j = vec![0usize, 3, 0, 1, 1, 2, 3];
        let a = vec![10.0, 2.0, 3.0, 9.0, 7.0, 8.0, 7.0];
        let x = vec![1.0, 2.0, 3.0, 4.0];

        assert_eq!(on_csr_row_dot(0, &i, &j, &a, &x), 18.0);
        assert_eq!(on_csr_row_dot(1, &i, &j, &a, &x), 21.0);
        assert_eq!(on_csr_row_dot(2, &i, &j, &a, &x), 66.0);
    }

    #[test]
    fn test_csr_from_dense() {
        let dense = vec![
            vec![10.0, 0.0, 0.0, 2.0],
            vec![ 3.0, 9.0, 0.0, 0.0],
            vec![ 0.0, 7.0, 8.0, 7.0],
        ];
        let (i, j, a) = on_csr_from_dense(&dense);
        println!("i = {:?}", i);
        println!("j = {:?}", j);
        println!("a = {:?}", a);
    }

    #[test]
    fn test_csr_from_triplets() {
        // ëª©í‘œ Aì˜ triplet
        let n_rows = 3;
        let n_cols = 4;
        let trips = vec![
            (0, 0, 10.0), (0, 3, 2.0),
            (1, 0, 3.0),  (1, 1, 9.0),
            (2, 1, 7.0),  (2, 2, 8.0), (2, 3, 7.0),
        ];

        let (i, j, a) = on_csr_from_triplets(n_rows, n_cols, trips);

        // í™•ì¸ ì¶œë ¥
        println!("i = {:?}", i); // [0, 2, 4, 7]
        println!("j = {:?}", j); // [0, 3, 0, 1, 1, 2, 3]
        println!("a = {:?}", a); // [10.0, 2.0, 3.0, 9.0, 7.0, 8.0, 7.0]
    }

    #[test]
    fn test_print_dense_from_csr() {
        // ì˜ˆì œ CSR (3x4)
        let i = vec![0usize, 2, 4, 7];                    // row pointer
        let j = vec![0usize, 3, 0, 1, 1, 2, 3];           // col indices
        let a = vec![10.0, 2.0, 3.0, 9.0, 7.0, 8.0, 7.0]; // values

        on_print_dense_from_csr(3, 4, &i, &j, &a);
    }

    #[test]
    fn test_print_from_csc() {
        let j = vec![0, 2, 4, 5, 7]; // ì—´ ì‹œì‘ ìœ„ì¹˜
        let i = vec![0, 1, 1, 2, 2, 0, 2]; // í–‰ ì¸ë±ìŠ¤
        let a = vec![10.0, 3.0, 9.0, 7.0, 8.0, 2.0, 7.0]; // ê°’

        on_print_from_csc(&j, &i, &a, 3, 4);
    }
}
```


